{% extends 'base.html' %}
{% load static %}
{% load form_filters %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Customer Orders</h2>

  {% for order in orders %}
    <div class="card mb-4 shadow rounded">
      <div class="card-header d-flex justify-content-between align-items-center bg-white" style="border-bottom: 1px solid #eee;">
        <div>
          <strong>Order #{{ order.id }}</strong> by <strong>{{ order.customer.email }}</strong>
        </div>
        <div class="d-flex align-items-center gap-2 flex-wrap" style="min-height: 48px;">
          {% if order.status == 'pending' %}
            <form method="post" class="d-inline-flex align-items-center gap-2 mb-0">
              {% csrf_token %}
              <input type="hidden" name="order_id" value="{{ order.id }}">
              <input type="hidden" name="action" value="confirm">
              <button type="submit" class="btn btn-primary btn-lg">Confirm Order</button>
            </form>
          {% elif order.status == 'confirmed' %}
            {% with eligible_riders=eligible_riders_map|get_item:order.id %}
              {% if eligible_riders %}
                <form method="post" class="d-inline-flex align-items-center gap-2 mb-0">
                  {% csrf_token %}
                  <input type="hidden" name="order_id" value="{{ order.id }}">
                  <input type="hidden" name="action" value="assign_rider">
                  <select name="rider_ids" class="form-select d-inline-block w-auto h-100 py-2" multiple required size="{{ eligible_riders|length|default:5 }}" style="min-width: 180px;">
                    {% for rider in eligible_riders %}
                      <option value="{{ rider.id }}">{{ rider.get_full_name|default:rider.email }} ({{ rider.phone }})</option>
                    {% endfor %}
                  </select>
                  <button type="submit" class="btn btn-success btn-sm h-100 py-2">Assign Riders</button>
                </form>
                <div class="form-text ms-2">Select 1–5 riders in order of priority (first is primary).</div>
              {% else %}
                <div class="alert alert-warning mb-0 py-2 px-3 d-flex align-items-center h-100" style="min-height: 40px;">No delivery riders are currently available for this area.</div>
                <form method="post" class="d-inline-flex align-items-center gap-2 ms-3 mb-0">
                  {% csrf_token %}
                  <input type="hidden" name="order_id" value="{{ order.id }}">
                  <select name="manual_status" class="form-select d-inline-block w-auto h-100 py-2" required>
                    <option value="" disabled selected>Update Status</option>
                    {% for value, label in manual_status_choices %}
                      <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                  <button type="submit" class="btn btn-secondary btn-sm h-100 py-2">Update</button>
                </form>
              {% endif %}
            {% endwith %}
          {% else %}
            <span class="badge bg-secondary">{{ order.get_status_display }}</span>
            {% if order.delivery_rider %}
              <span class="ms-2">Rider: {{ order.delivery_rider.get_full_name|default:order.delivery_rider.email }}</span>
            {% endif %}
            {% if order.status == 'shipped' or order.status == 'out_for_delivery' %}
              <form method="post" class="d-inline-flex align-items-center gap-2 mb-0 ms-3">
                {% csrf_token %}
                <input type="hidden" name="order_id" value="{{ order.id }}">
                <input type="hidden" name="action" value="mark_delivered">
                <button type="submit" class="btn btn-success btn-sm h-100 py-2">Mark as Delivered</button>
              </form>
            {% endif %}
          {% endif %}
        </div>
      </div>
      <div class="card-body" style="background: #f6fbf8;">
        {% for item in order.items.all %}
          <div class="d-flex align-items-center mb-3">
            <div style="width: 110px;">
              <img src="{{ item.product.image.url }}" class="img-fluid rounded" alt="{{ item.product.name }}">
            </div>
            <div class="ms-4 flex-grow-1">
              <div class="fw-bold mb-1">{{ item.product.name }}</div>
              <div class="text-muted small mb-2">{{ item.product.description|truncatewords:15 }}</div>
              <div class="mb-2"><span class="fw-semibold">Qty:</span> {{ item.quantity }} <span class="fw-semibold ms-2">@ ₹{{ item.price|floatformat:2 }}</span></div>
            </div>
          </div>
          <hr>
        {% endfor %}
        <div class="text-end fw-bold fs-5 mt-3">Total Amount: ₹{{ order.total_amount|floatformat:2 }}</div>
      </div>
    </div>
  {% empty %}
    <p>No orders found.</p>
  {% endfor %}
</div>
{% endblock %}
