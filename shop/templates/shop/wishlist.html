{% extends 'shop/base_customer.html' %}
{% load static %}
{% block content %}
<div class="container py-4">
  <h2 class="text-center mb-4 text-3xl font-bold">Your Wishlist</h2>

  {% if wishlist_items %}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
      {% for item in wishlist_items %}
        <div class="col">
          <div class="card h-100 position-relative group shadow-sm hover:shadow-md transition">

            <!-- Wishlist Toggle Button -->
            <button class="wishlist-btn position-absolute top-0 end-0 m-2 btn p-1 text-danger z-3"
                    data-product-id="{{ item.product.id }}">
              <i class="bi bi-heart-fill text-red-600"></i>
            </button>

            <!-- Entire Card Clickable -->
            <a href="{% url 'product_detail' item.product.id %}" class="text-decoration-none text-dark">
              {% if item.product.image %}
                <img src="{{ item.product.image.url }}" class="card-img-top p-2" alt="{{ item.product.name }}">
              {% else %}
                <img src="https://via.placeholder.com/300x200?text=No+Image" class="card-img-top p-2" alt="No Image">
              {% endif %}

              <div class="card-body d-flex flex-column">
                <h5 class="card-title fw-semibold mb-1">{{ item.product.name }}</h5>
                <p class="card-text text-muted small mb-2">{{ item.product.description|truncatewords:10 }}</p>
                <p class="text-primary fw-bold mb-3">â‚¹{{ item.product.price }}</p>
                <div class="btn btn-sm btn-outline-primary mt-auto text-center w-100">View Product</div>
              </div>
            </a>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-center text-muted mt-5">Your wishlist is empty.</p>
  {% endif %}
</div>

<!-- Wishlist Toggle Script -->
<script>
  document.querySelectorAll('.wishlist-btn').forEach(button => {
    button.addEventListener('click', function (e) {
      e.preventDefault();
      e.stopPropagation(); // Prevent card redirect

      const productId = this.dataset.productId;
      const icon = this.querySelector('i');

      fetch("{% url 'toggle_wishlist' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({ product_id: productId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "removed") {
          // Fade out or reload on remove
          this.closest('.col').remove();
        }
      });
    });
  });
</script>
{% endblock %}
